<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title id="app-title">æ±äº¬ä¹‹æ—… 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        html, body {
            height: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow-x: hidden !important;
            box-sizing: border-box !important;
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f3f4f6;
            -webkit-font-smoothing: antialiased; 
            -webkit-tap-highlight-color: transparent;
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .modal {
            opacity: 0;
            visibility: hidden;
            display: none; 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 9999 !important; 
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }
        .modal.active {
            opacity: 1;
            visibility: visible;
            display: flex; 
        }

        .fixed-header {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 1000 !important; 
        }
        
        .fixed-footer {
            position: fixed !important;
            bottom: 24px !important; 
            left: 24px !important;
            right: 24px !important;
            z-index: 1001 !important; 
        }

        .page-content {
            padding-top: 150px; 
            padding-bottom: 7rem; 
            min-height: 100vh;
        }
        
        #budget-page, #checklist-page {
            padding-top: 2rem;
        }

        .check-item.completed .check-text {
            text-decoration: line-through;
            color: #9ca3af;
        }
        .check-circle {
            transition: all 0.2s;
        }
        .check-item.completed .check-circle {
            background-color: #10b981;
            border-color: #10b981;
            color: white;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="schedule-page" class="page-content">
        <div class="fixed-header bg-white/95 backdrop-blur-md border-b border-gray-200 pt-10 pb-2 px-4 shadow-sm">
            <div class="flex justify-between items-center mb-2">
                <div>
                    <p class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Tokyo Trip 2026</p>
                    <h1 class="text-xl font-black text-gray-900 leading-tight" id="current-day-title">Day 1 å‡ºç™¼</h1>
                </div>
                
                <div class="bg-blue-50 border border-blue-100 rounded-full px-3 py-1 flex items-center gap-2 shadow-sm">
                    <div id="weather-icon-container" class="text-blue-500 text-lg">
                        <i class="fas fa-sync fa-spin"></i>
                    </div>
                    <div class="text-right leading-none">
                        <div id="weather-temp" class="text-sm font-bold text-gray-800">--Â°C</div>
                        <div id="weather-desc" class="text-[10px] text-gray-500">è¼‰å…¥ä¸­</div>
                    </div>
                </div>
            </div>
            
            <div class="flex overflow-x-auto gap-4 mt-2 pb-2 hide-scrollbar z-10" id="date-slider"></div>
        </div>

        <div class="px-4 space-y-5"> 
            <div class="relative w-full h-40 rounded-2xl overflow-hidden shadow-lg bg-gray-900 group" id="hero-card">
                <div id="hero-image" class="absolute inset-0 bg-gradient-to-r from-gray-900 to-gray-800 z-0"></div>
                <div class="absolute bottom-0 left-0 right-0 p-4 text-white z-10">
                    <div class="flex justify-between items-end">
                        <div>
                            <div class="text-[10px] font-bold bg-white/20 backdrop-blur-sm px-2 py-0.5 inline-block rounded mb-1 border border-white/10" id="hero-tag">å•Ÿç¨‹</div>
                            <h2 class="text-lg font-bold tracking-wide" id="hero-main-title">æ±äº¬ä¸ƒæ—¥éŠ Start!</h2>
                        </div>
                        <div class="text-right">
                             <p class="text-[10px] text-gray-300" id="hero-subtitle">--</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="loading-status" class="text-center text-xs text-gray-400 mt-2">
                 <i class="fas fa-spinner fa-spin mr-1"></i> è³‡æ–™åŒæ­¥ä¸­...
            </div>
            
            <div id="schedule-container" class="space-y-5 pb-10"></div>
        </div>
    </div>

    <div id="budget-page" class="hidden page-content px-4">
        <h1 class="text-2xl font-black mb-4 flex items-center gap-2">
            <span class="bg-yellow-100 text-yellow-600 p-2 rounded-lg text-xl"><i class="fas fa-coins"></i></span>
            æ—…è²»ä¸­å¿ƒ
        </h1> 

        <div class="bg-gray-900 text-white p-6 rounded-2xl shadow-xl mb-6 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full -mr-10 -mt-10 blur-2xl"></div>
            
            <div class="flex justify-between items-center mb-4 relative z-10">
                <p class="text-xs uppercase opacity-60 font-bold tracking-wider">Total Spent</p>
                <button onclick="prepareRateModal()" class="text-xs bg-white/10 hover:bg-white/20 px-2 py-1 rounded transition">
                    åŒ¯ç‡: <span id="display-rate">0.22</span> <i class="fas fa-pen ml-1"></i>
                </button>
            </div>
            <div class="relative z-10">
                <div class="text-4xl font-black tracking-tight" id="total-jpy">Â¥ 0</div>
                <div class="text-sm opacity-60 mt-1 font-medium" id="total-twd">â‰ˆ NT$ 0</div>
            </div>
        </div>
        
        <div class="flex justify-between items-center mb-3 border-b border-gray-200 pb-2">
             <h2 class="text-lg font-bold text-gray-700">ä»Šæ—¥æ˜ç´° (<span id="current-day-budget">Day 1</span>)</h2>
             <div class="text-lg font-bold text-red-600 bg-red-50 px-2 rounded" id="daily-jpy">Â¥ 0</div>
        </div>
        
        <div id="budget-list" class="space-y-3 pb-6">
            <div id="budget-loading" class="text-center text-sm text-gray-500 mt-4">
                 <i class="fas fa-spinner fa-spin mr-2"></i> è®€å–å¸³ç›®ä¸­...
            </div>
        </div>
        
        <button onclick="showModal('add-budget-modal')" class="fixed bottom-[100px] right-5 bg-gray-900 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-2xl active:scale-95 transition-transform z-30">
            <i class="fas fa-plus text-xl"></i>
        </button>
    </div>

    <div id="checklist-page" class="hidden page-content px-4">
        <h1 class="text-2xl font-black mb-4 flex items-center gap-2">
            <span class="bg-purple-100 text-purple-600 p-2 rounded-lg text-xl"><i class="fas fa-clipboard-check"></i></span>
            å¿…è²· & æº–å‚™æ¸…å–®
        </h1>

        <div class="flex gap-2 mb-4">
            <input type="text" id="checklist-input" placeholder="æ–°å¢é …ç›®..." 
                class="flex-1 p-3 border border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
            <button onclick="addChecklistItem()" class="bg-purple-600 text-white px-4 rounded-xl font-bold shadow-md active:scale-95 transition">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <div id="checklist-container" class="space-y-2 pb-20">
            <div class="text-center text-gray-400 text-sm mt-10">
                <i class="fas fa-box-open text-2xl mb-2"></i><br>æ¸…å–®ç›®å‰æ˜¯ç©ºçš„
            </div>
        </div>
    </div>

    <div id="add-modal" class="modal inset-0 bg-black/60 backdrop-blur-sm items-center justify-center p-4" onclick="closeModal('add-modal')">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl transform transition-all scale-100" onclick="event.stopPropagation()">
            <h2 class="text-xl font-bold mb-4 text-gray-800">æ–°å¢è¡Œç¨‹</h2>
            <div class="space-y-3">
                <div class="flex gap-2">
                    <input type="time" id="new-time" class="w-1/3 p-3 bg-gray-50 border border-gray-200 rounded-xl text-lg font-bold text-center" value="09:00">
                    <select id="new-category" class="w-2/3 p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm font-medium">
                        <option value="FOOD">ğŸ´ é¤é£²</option>
                        <option value="SIGHTSEEING">â›© æ™¯é»</option>
                        <option value="TRANSPORT">ğŸš„ äº¤é€š</option>
                        <option value="SHOPPING">ğŸ› è³¼ç‰©</option>
                        <option value="HOTEL">ğŸ¨ ä½å®¿</option>
                        <option value="OTHER">ğŸ’¡ å…¶ä»–</option>
                    </select>
                </div>
                <input type="text" id="new-title" placeholder="è¡Œç¨‹æ¨™é¡Œ" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold">
                <input type="text" id="new-location" placeholder="ğŸ“ åœ°é»åç¨± (Google Maps)" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm">
                <textarea id="new-content" placeholder="å‚™è¨»å…§å®¹..." class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl h-24 text-sm"></textarea>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeModal('add-modal')" class="px-5 py-2.5 text-gray-500 font-medium rounded-xl hover:bg-gray-100">å–æ¶ˆ</button>
                <button onclick="addScheduleItem()" class="px-5 py-2.5 bg-green-600 text-white rounded-xl shadow-lg shadow-green-200 font-bold hover:bg-green-700">æ–°å¢</button>
            </div>
        </div>
    </div>
    
    <div id="edit-modal" class="modal inset-0 bg-black/60 backdrop-blur-sm items-center justify-center p-4" onclick="closeModal('edit-modal')">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl" onclick="event.stopPropagation()">
            <h2 class="text-xl font-bold mb-4 text-gray-800">ç·¨è¼¯è¡Œç¨‹</h2>
            <div class="space-y-3">
                <div class="flex gap-2">
                    <input type="time" id="edit-time" class="w-1/3 p-3 bg-gray-50 border border-gray-200 rounded-xl text-lg font-bold text-center">
                    <select id="edit-category" class="w-2/3 p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm font-medium">
                        <option value="FOOD">ğŸ´ é¤é£²</option>
                        <option value="SIGHTSEEING">â›© æ™¯é»</option>
                        <option value="TRANSPORT">ğŸš„ äº¤é€š</option>
                        <option value="SHOPPING">ğŸ› è³¼ç‰©</option>
                        <option value="HOTEL">ğŸ¨ ä½å®¿</option>
                        <option value="OTHER">ğŸ’¡ å…¶ä»–</option>
                    </select>
                </div>
                <input type="text" id="edit-title" placeholder="è¡Œç¨‹æ¨™é¡Œ" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold">
                <input type="text" id="edit-location" placeholder="ğŸ“ åœ°é»åç¨± (Google Maps)" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm">
                <textarea id="edit-content" placeholder="è©³ç´°å…§å®¹..." class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl h-24 text-sm"></textarea>
            </div>
            <div class="flex justify-between items-center mt-6">
                 <button onclick="deleteScheduleItem()" class="px-4 py-2 text-red-500 rounded-xl hover:bg-red-50 text-sm font-medium"><i class="fas fa-trash-alt mr-1"></i> åˆªé™¤</button>
                <div class="space-x-2">
                    <button onclick="closeModal('edit-modal')" class="px-4 py-2 text-gray-500 font-medium rounded-xl hover:bg-gray-100">å–æ¶ˆ</button>
                    <button onclick="saveEdit()" class="px-5 py-2 bg-blue-600 text-white rounded-xl shadow-lg shadow-blue-200 font-bold hover:bg-blue-700">å„²å­˜</button>
                </div>
            </div>
             <input type="hidden" id="editing-item-id">
        </div>
    </div>
    
    <div id="add-budget-modal" class="modal inset-0 bg-black/60 backdrop-blur-sm items-center justify-center p-4" onclick="closeModal('add-budget-modal')">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl" onclick="event.stopPropagation()">
            <h2 class="text-xl font-bold mb-4">è¨˜ä¸€ç­† (<span id="add-budget-day">Day 1</span>)</h2>
            <div class="space-y-3">
                <input type="number" id="budget-amount" placeholder="é‡‘é¡ (æ—¥åœ“ Â¥)" class="w-full p-4 border-2 border-red-100 rounded-xl text-2xl font-bold text-center text-red-600 focus:border-red-500 focus:outline-none">
                <input type="text" id="budget-description" placeholder="é …ç›®åç¨± (ä¾‹å¦‚: æ‹‰éºµ)" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl">
                <select id="budget-category" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl">
                    <option value="FOOD">ğŸ´ é¤é£²</option>
                    <option value="TRANSPORT">ğŸš„ äº¤é€š</option>
                    <option value="SHOPPING">ğŸ› è³¼ç‰©</option>
                    <option value="SIGHTSEEING">â›© é–€ç¥¨</option>
                    <option value="HOTEL">ğŸ¨ ä½å®¿</option>
                    <option value="OTHER">ğŸ’¡ å…¶ä»–</option>
                </select>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeModal('add-budget-modal')" class="px-5 py-2 text-gray-500 rounded-xl hover:bg-gray-100">å–æ¶ˆ</button>
                <button onclick="addBudgetItem()" class="px-5 py-2 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 shadow-lg shadow-red-200">ç¢ºå®š</button>
            </div>
        </div>
    </div>
    
    <div id="rate-modal" class="modal inset-0 bg-black/60 backdrop-blur-sm items-center justify-center p-4" onclick="closeModal('rate-modal')">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl" onclick="event.stopPropagation()">
            <h2 class="text-xl font-bold mb-2">åŒ¯ç‡è¨­å®š</h2>
            <p class="text-sm text-gray-500 mb-4">ç›®å‰çš„åŒ¯ç‡: 1 JPY â‰ˆ ? TWD</p>
            <div class="flex items-center space-x-2 bg-gray-50 p-4 rounded-xl border border-gray-200">
                <span class="text-lg font-bold text-gray-400">Ã—</span>
                <input type="number" step="0.0001" id="exchange-rate-input" class="flex-1 bg-transparent text-2xl font-bold text-center focus:outline-none" placeholder="0.22">
            </div>
            <div class="flex justify-end mt-6">
                <button onclick="saveExchangeRate()" class="px-5 py-2 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-lg">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div class="fixed-footer bg-white text-gray-400 rounded-2xl shadow-[0_8px_30px_rgb(0,0,0,0.12)] h-16 flex items-center justify-around px-2 border border-gray-100">
        <button id="tab-schedule" onclick="switchPage('schedule')" class="p-2 w-14 flex flex-col items-center justify-center text-green-600 transition-colors">
            <i class="fas fa-map-marked-alt text-xl mb-1"></i>
            <span class="text-[9px] font-bold">è¡Œç¨‹</span>
        </button>
        <button id="tab-checklist" onclick="switchPage('checklist')" class="p-2 w-14 flex flex-col items-center justify-center hover:text-purple-500 transition-colors">
            <i class="fas fa-clipboard-list text-xl mb-1"></i>
            <span class="text-[9px] font-bold">æ¸…å–®</span>
        </button>
        <div id="add-schedule-btn" onclick="showModal('add-modal')" class="bg-gray-900 text-white w-12 h-12 rounded-xl flex items-center justify-center -mt-8 shadow-lg shadow-gray-400/50 cursor-pointer active:scale-95 transition-transform border-4 border-gray-100">
            <i class="fas fa-plus text-lg"></i>
        </div>
        <button class="p-2 w-14 flex flex-col items-center justify-center hover:text-blue-500 transition-colors pointer-events-none opacity-30">
            <i class="fas fa-subway text-xl mb-1"></i>
            <span class="text-[9px] font-bold">åœ°åœ–</span>
        </button>
        <button id="tab-budget" onclick="switchPage('budget')" class="p-2 w-14 flex flex-col items-center justify-center hover:text-yellow-600 transition-colors">
            <i class="fas fa-wallet text-xl mb-1"></i>
            <span class="text-[9px] font-bold">è¨˜å¸³</span>
        </button>
    </div>


<script>
    // =======================================================
    // å…¨åŸŸè®Šæ•¸ & é…ç½®
    // =======================================================
    let currentDay = 1; 
    let currentItems = []; 
    let firestoreScheduleListener = null;
    let firestoreBudgetListener = null;
    let firestoreChecklistListener = null;
    let exchangeRate = 0.22; 
    let allBudgetItems = []; 
    let checklistItems = [];

    const OPENWEATHER_API_KEY = '54f22a6f3141e619d73a09a6d4136e88'; 
    const WEATHER_CITY_ID = '1850147'; 
    const WEATHER_URL = `https://api.openweathermap.org/data/2.5/weather?id=${WEATHER_CITY_ID}&appid=${OPENWEATHER_API_KEY}&units=metric&lang=zh_tw`;

    const TRIP_DATES = [
        { day: 1, label: 'Day 1 å‡ºç™¼', week: 'WED', date: '04', title: 'æ±äº¬ Start!', tag: 'å•Ÿç¨‹', heroTitle: 'æ±äº¬ä¸ƒæ—¥éŠ Start!' },
        { day: 2, label: 'Day 2 æ¢ç´¢', week: 'THU', date: '05', title: 'ç¯‰åœ°ã€æ·ºè‰', tag: 'æ¢ç´¢', heroTitle: 'ç¯‰åœ°ã€æ·ºè‰' },
        { day: 3, label: 'Day 3 è³¼ç‰©', week: 'FRI', date: '06', title: 'æ–°å®¿ã€æ¾€è°·', tag: 'è³¼ç‰©', heroTitle: 'æ–°å®¿ã€æ¾€è°·' },
        { day: 4, label: 'Day 4 å‹•æ¼«', week: 'SAT', date: '07', title: 'ç§‹è‘‰åŸ', tag: 'å‹•æ¼«', heroTitle: 'ç§‹è‘‰åŸæ¢éšª' },
        { day: 5, label: 'Day 5 æ¨‚åœ’', week: 'SUN', date: '08', title: 'è¿ªå£«å°¼', tag: 'æ¨‚åœ’', heroTitle: 'è¿ªå£«å°¼é­”æ³•' },
        { day: 6, label: 'Day 6 æ©«æ¿±', week: 'MON', date: '09', title: 'æ©«æ¿±ä¸€æ—¥', tag: 'è¿‘éƒŠ', heroTitle: 'æ©«æ¿±æ¸¯æœªä¾†' },
        { day: 7, label: 'Day 7 å›ç¨‹', week: 'TUE', date: '10', title: 'Bye Tokyo', tag: 'è¿”å°', heroTitle: 'æ»¿è¼‰è€Œæ­¸' },
    ];

    const firebaseConfig = {
      apiKey: "AIzaSyAWU_CfnTi1zdC11zegEnCjqVKGnwJ-JOY",
      authDomain: "tokyo-trip-2026.firebaseapp.com",
      projectId: "tokyo-trip-2026",
      storageBucket: "tokyo-trip-2026.appspot.com",
      messagingSenderId: "495258057956",
      appId: "1:495258057956:web:d47fd494872c84032c80f1"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    const SCHEDULE_COLLECTION = 'trip_schedules';
    const BUDGET_COLLECTION = 'trip_budgets';
    const CHECKLIST_COLLECTION = 'trip_checklist'; 
    const CONFIG_DOCUMENT_ID = 'trip_config';

    function getDocumentId(day) {
        return `tokyo_feb_2026_day_${day}`;
    }
    
    // =======================================================
    // å¤©æ°£åŠŸèƒ½
    // =======================================================

    function getWeatherIcon(iconCode) {
        if (iconCode.startsWith('01')) return 'fas fa-sun text-yellow-500'; 
        if (iconCode.startsWith('02')) return 'fas fa-cloud-sun text-yellow-400'; 
        if (iconCode.startsWith('03') || iconCode.startsWith('04')) return 'fas fa-cloud text-gray-400'; 
        if (iconCode.startsWith('09') || iconCode.startsWith('10')) return 'fas fa-cloud-showers-heavy text-blue-500'; 
        if (iconCode.startsWith('11')) return 'fas fa-bolt text-indigo-500'; 
        if (iconCode.startsWith('13')) return 'fas fa-snowflake text-cyan-400'; 
        if (iconCode.startsWith('50')) return 'fas fa-smog text-gray-400'; 
        return 'fas fa-question text-gray-300';
    }

    async function fetchWeather() {
        try {
            const response = await fetch(WEATHER_URL);
            const data = await response.json();
            if (!response.ok || data.cod !== 200) throw new Error(`Weather Error`);
            updateWeatherDisplay(data);
        } catch (error) {
            document.getElementById('weather-desc').textContent = 'N/A';
        }
    }

    function updateWeatherDisplay(data) {
        const temp = Math.round(data.main.temp);
        const description = data.weather[0].description;
        const iconCode = data.weather[0].icon;
        document.getElementById('weather-temp').textContent = `${temp}Â°C`;
        document.getElementById('weather-desc').textContent = description;
        document.getElementById('weather-icon-container').innerHTML = `<i class="${getWeatherIcon(iconCode)}"></i>`;
    }

    // =======================================================
    // Checklist åŠŸèƒ½
    // =======================================================
    
    function listenForChecklistUpdates() {
        if (firestoreChecklistListener) firestoreChecklistListener();
        firestoreChecklistListener = db.collection(CHECKLIST_COLLECTION).orderBy('timestamp', 'desc')
            .onSnapshot(snapshot => {
                checklistItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderChecklist();
            });
    }

    async function addChecklistItem() {
        const input = document.getElementById('checklist-input');
        const text = input.value.trim();
        if(!text) return;
        try {
            await db.collection(CHECKLIST_COLLECTION).add({
                text: text, isCompleted: false, timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            input.value = '';
        } catch (e) {}
    }

    async function toggleChecklist(id, currentStatus) {
        try { await db.collection(CHECKLIST_COLLECTION).doc(id).update({ isCompleted: !currentStatus }); } catch (e) {}
    }

    async function deleteChecklist(id) {
        if(!confirm("åˆªé™¤æ­¤é …ç›®ï¼Ÿ")) return;
        try { await db.collection(CHECKLIST_COLLECTION).doc(id).delete(); } catch (e) {}
    }

    function renderChecklist() {
        const container = document.getElementById('checklist-container');
        container.innerHTML = '';
        if(checklistItems.length === 0) {
            container.innerHTML = `<div class="text-center text-gray-400 text-sm mt-10"><i class="fas fa-box-open text-2xl mb-2"></i><br>æ¸…å–®ç›®å‰æ˜¯ç©ºçš„</div>`;
            return;
        }
        checklistItems.sort((a, b) => a.isCompleted - b.isCompleted);
        checklistItems.forEach(item => {
            const completedClass = item.isCompleted ? 'completed' : '';
            const iconClass = item.isCompleted ? 'fa-check' : '';
            const html = `
                <div class="check-item flex items-center bg-white p-3 rounded-xl shadow-sm border border-gray-100 ${completedClass}">
                    <div onclick="toggleChecklist('${item.id}', ${item.isCompleted})" class="check-circle cursor-pointer w-6 h-6 rounded-full border-2 border-gray-300 mr-3 flex items-center justify-center text-xs">
                         <i class="fas ${iconClass}"></i>
                    </div>
                    <div class="flex-1 check-text font-medium text-gray-700 select-none cursor-pointer" onclick="toggleChecklist('${item.id}', ${item.isCompleted})">${item.text}</div>
                    <button onclick="deleteChecklist('${item.id}')" class="text-gray-300 hover:text-red-400 px-2"><i class="fas fa-times"></i></button>
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    // =======================================================
    // åŒ¯ç‡èˆ‡è¨˜å¸³ (æ ¸å¿ƒä¿®æ”¹å€)
    // =======================================================
    async function loadExchangeRate() {
        try {
            const doc = await db.collection(BUDGET_COLLECTION).doc(CONFIG_DOCUMENT_ID).get();
            if (doc.exists && doc.data().rate) {
                exchangeRate = doc.data().rate;
                document.getElementById('display-rate').textContent = exchangeRate;
            }
        } catch (e) {}
    }

    async function saveExchangeRate() {
        const inputRate = parseFloat(document.getElementById('exchange-rate-input').value);
        if (isNaN(inputRate) || inputRate <= 0) return alert("è«‹è¼¸å…¥æœ‰æ•ˆåŒ¯ç‡");
        exchangeRate = inputRate;
        try {
            await db.collection(BUDGET_COLLECTION).doc(CONFIG_DOCUMENT_ID).set({ rate: exchangeRate }, { merge: true });
            document.getElementById('display-rate').textContent = exchangeRate;
            closeModal('rate-modal');
            renderBudgetSummary(); renderBudgetList();
        } catch (e) { alert("å„²å­˜å¤±æ•—"); }
    }

    function prepareRateModal() {
        document.getElementById('exchange-rate-input').value = exchangeRate;
        showModal('rate-modal');
    }

    async function addBudgetItem() {
        const descInput = document.getElementById('budget-description');
        const amountInput = document.getElementById('budget-amount');
        const catInput = document.getElementById('budget-category');
        
        const desc = descInput.value;
        const amount = parseFloat(amountInput.value);
        const cat = catInput.value;
        
        if (!desc || isNaN(amount) || amount <= 0) return alert("è«‹è¼¸å…¥é‡‘é¡èˆ‡å…§å®¹");
        
        closeModal('add-budget-modal');
        descInput.value = '';
        amountInput.value = '';

        try {
            await db.collection(BUDGET_COLLECTION).add({
                description: desc, 
                amount: amount, 
                category: cat, 
                day: currentDay, 
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch (e) {
            console.error(e);
            alert("âš ï¸ å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š");
        }
    }
    
    async function deleteBudgetItem(id) {
         if(!confirm('åˆªé™¤é€™ç­†é–‹éŠ·ï¼Ÿ')) return;
        try { await db.collection(BUDGET_COLLECTION).doc(id).delete(); } catch (e) {}
    }

    function listenForBudgetUpdates() {
        if (firestoreBudgetListener) firestoreBudgetListener();
        firestoreBudgetListener = db.collection(BUDGET_COLLECTION).orderBy('timestamp', 'desc')
            .onSnapshot(snapshot => {
                allBudgetItems = snapshot.docs.map(doc => ({ 
                    id: doc.id, ...doc.data(), day: Number(doc.data().day) || 0 
                }));
                renderBudgetSummary(); 
                if(!document.getElementById('budget-page').classList.contains('hidden')) renderBudgetList();
            });
    }

    function renderBudgetSummary() {
        const dailyTotal = allBudgetItems.filter(i => i.day == currentDay).reduce((sum, i) => sum + i.amount, 0);
        const totalJPY = allBudgetItems.reduce((sum, i) => sum + i.amount, 0);
        const totalTWD = totalJPY * exchangeRate;
        document.getElementById('current-day-budget').textContent = `Day ${currentDay}`;
        document.getElementById('daily-jpy').textContent = `Â¥ ${dailyTotal.toLocaleString('en-US')}`;
        document.getElementById('total-jpy').textContent = `Â¥ ${totalJPY.toLocaleString('en-US')}`;
        document.getElementById('total-twd').textContent = `â‰ˆ NT$ ${Math.round(totalTWD).toLocaleString('en-US')}`;
    }

    // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¾©ï¼šç¢ºä¿åˆ—è¡¨è³‡æ–™çµ•å°é¡¯ç¤º â˜…â˜…â˜…
    function renderBudgetList() {
        const listContainer = document.getElementById('budget-list');
        listContainer.innerHTML = '';
        document.getElementById('budget-loading').style.display = 'none';

        const currentDayItems = allBudgetItems.filter(item => item.day == currentDay); 
        
        if (currentDayItems.length === 0) {
            listContainer.innerHTML = `
                <div class="text-center text-gray-400 py-10 opacity-60">
                    <i class="fas fa-receipt text-4xl mb-3"></i>
                    <p>ä»Šæ—¥é‚„æ²’æœ‰èŠ±è²»è¨˜éŒ„</p>
                </div>`;
            return;
        }

        // æ’åºï¼šç¢ºä¿å‰›æ–°å¢çš„è³‡æ–™(æ™‚é–“ç‚ºnullæˆ–0) æ’åœ¨æœ€ä¸Šé¢
        const sortedItems = [...currentDayItems].sort((a, b) => {
            // å¦‚æœ timestamp ç‚º null (æœ¬åœ°å‰›å¯«å…¥)ï¼Œè¦–ç‚ºã€Œç¾åœ¨ã€ (Infinity/Max) è®“å®ƒæ’æœ€ä¸Šé¢
            const timeA = (a.timestamp && a.timestamp.seconds) ? a.timestamp.seconds : Number.MAX_SAFE_INTEGER;
            const timeB = (b.timestamp && b.timestamp.seconds) ? b.timestamp.seconds : Number.MAX_SAFE_INTEGER;
            return timeB - timeA;
        });

        sortedItems.forEach(item => {
            const vibe = getCategoryVibe(item.category);
            
            let timeStr = 'å‰›å‰›';
            // å®‰å…¨è™•ç†æ™‚é–“æ ¼å¼
            if (item.timestamp && item.timestamp.toDate) {
                const date = item.timestamp.toDate();
                timeStr = date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });
            }

            const twdAmount = Math.round(item.amount * exchangeRate);

            // ç›´æ¥ç”¨ style è¨­å®šé¡è‰²ï¼Œé¿å… Tailwind å‹•æ…‹ class å¤±æ•ˆ
            const itemHTML = `
                <div class="bg-white rounded-xl shadow-sm overflow-hidden relative group" style="border-left: 4px solid ${vibe.hex || '#gray'};">
                    <div class="p-3 flex items-center justify-between gap-3">
                        <div class="flex flex-col items-center justify-center w-10 min-w-[2.5rem]">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center mb-1" style="background-color: ${vibe.bgHex}; color: ${vibe.hex};">
                                <i class="${vibe.icon} text-sm"></i>
                            </div>
                            <span class="text-[9px] font-bold text-gray-400">${timeStr}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-gray-800 text-base truncate leading-snug">${item.description}</h4>
                            <div class="flex items-center gap-2 mt-0.5">
                                <span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">${vibe.label}</span>
                            </div>
                        </div>
                        <div class="text-right pl-2 shrink-0">
                            <div class="font-black text-gray-800 text-lg leading-none">Â¥${item.amount.toLocaleString()}</div>
                            <div class="text-xs text-gray-400 font-medium mt-1">â‰ˆ $${twdAmount.toLocaleString()}</div>
                        </div>
                    </div>
                    <button onclick="deleteBudgetItem('${item.id}')" class="absolute top-0 right-0 p-2 text-gray-300 hover:text-red-500 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>`;
            listContainer.insertAdjacentHTML('beforeend', itemHTML);
        });
    }
    
    // æ›´æ–°é¡è‰²é…ç½®ï¼ŒåŠ å…¥ Hex ç¢¼ç¢ºä¿é¡¯ç¤º
    function getCategoryVibe(category) {
        const map = {
            'FOOD': { hex: '#f97316', bgHex: '#ffedd5', icon: 'fas fa-utensils', label: 'é¤é£²' }, // Orange
            'SIGHTSEEING': { hex: '#ef4444', bgHex: '#fee2e2', icon: 'fas fa-torii-gate', label: 'æ™¯é»' }, // Red
            'TRANSPORT': { hex: '#3b82f6', bgHex: '#dbeafe', icon: 'fas fa-train', label: 'äº¤é€š' }, // Blue
            'ARRIVAL': { hex: '#3b82f6', bgHex: '#dbeafe', icon: 'fas fa-plane-arrival', label: 'æŠµé”' },
            'SHOPPING': { hex: '#ec4899', bgHex: '#fce7f3', icon: 'fas fa-shopping-bag', label: 'è³¼ç‰©' }, // Pink
            'HOTEL': { hex: '#a855f7', bgHex: '#f3e8ff', icon: 'fas fa-bed', label: 'ä½å®¿' }, // Purple
            'OTHER': { hex: '#6b7280', bgHex: '#f3f4f6', icon: 'fas fa-star', label: 'å…¶ä»–' } // Gray
        };
        return map[category] || map['OTHER'];
    }

    // =======================================================
    // é é¢åˆ‡æ›
    // =======================================================
    function switchPage(page) {
        document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
        document.getElementById(`${page}-page`).classList.remove('hidden');
        ['schedule', 'budget', 'checklist'].forEach(tab => {
            const btn = document.getElementById(`tab-${tab}`);
            if(btn) { btn.classList.remove('text-green-600', 'text-yellow-600', 'text-purple-600'); btn.classList.add('text-gray-400'); }
        });
        const activeBtn = document.getElementById(`tab-${page}`);
        if(page === 'schedule') {
            activeBtn.classList.add('text-green-600'); document.getElementById('app-title').textContent = `æ±äº¬ä¹‹æ—… - è¡Œç¨‹`;
            document.getElementById('add-schedule-btn').style.display = 'flex';
        } else if (page === 'budget') {
            activeBtn.classList.add('text-yellow-600'); document.getElementById('app-title').textContent = `æ—…è²»ä¸­å¿ƒ`;
            renderBudgetSummary(); renderBudgetList();
            document.getElementById('add-schedule-btn').style.display = 'none';
        } else if (page === 'checklist') {
            activeBtn.classList.add('text-purple-600'); document.getElementById('app-title').textContent = `å¿…è²·æ¸…å–®`;
            renderChecklist();
            document.getElementById('add-schedule-btn').style.display = 'none';
        }
    }

    // =======================================================
    // è¡Œç¨‹ç®¡ç†
    // =======================================================
    function getInitialSchedule(day) {
        if (day === 1) return [
            { id: 'item-flight-out', time: '15:20', title: 'å‡ºç™¼ BR0196', content: 'TPE T2 â†’ NRT T1', category: 'TRANSPORT', isStatic: true },
            { id: 'item-arrival', time: '19:20', title: 'æŠµé”æˆç”°', content: 'å…¥å¢ƒã€é ˜è¡Œæ', category: 'ARRIVAL', isStatic: true },
            { id: 'item-hotel-ph', time: '21:30', title: 'é£¯åº— Check-in', content: 'è¼¸å…¥é£¯åº—åç¨±', category: 'HOTEL', isStatic: true }
        ];
        if (day === 7) return [
            { id: 'item-check-out', time: '10:00', title: 'Check-out', content: 'å‰å¾€æ©Ÿå ´', category: 'HOTEL', isStatic: true },
            { id: 'item-flight-back', time: '14:00', title: 'å›ç¨‹ BR0197', content: 'NRT T1 â†’ TPE T2', category: 'TRANSPORT', isStatic: true }
        ];
        return [{ id: 'item-bf-ph', time: '09:00', title: 'æ—©é¤', content: 'ç¾å¥½çš„ä¸€å¤©', category: 'FOOD', isStatic: true }];
    }

    async function saveScheduleToFirestore(items) {
        const savableItems = items.filter(item => item.id.startsWith('custom-') || ['item-hotel-ph','item-bf-ph','item-check-out'].includes(item.id));
        try { await db.collection(SCHEDULE_COLLECTION).doc(getDocumentId(currentDay)).set({ schedule: savableItems, lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }); } catch (e) { console.error(e); }
    }
    
    function listenForScheduleUpdates(day) {
        if (firestoreScheduleListener) firestoreScheduleListener();
        const loading = document.getElementById('loading-status');
        firestoreScheduleListener = db.collection(SCHEDULE_COLLECTION).doc(getDocumentId(day)).onSnapshot(doc => {
            loading.style.opacity = '0';
            const initial = getInitialSchedule(day);
            if (doc.exists) {
                const saved = doc.data().schedule || [];
                currentItems = [...initial];
                saved.forEach(sItem => {
                    const idx = currentItems.findIndex(i => i.id === sItem.id);
                    if (idx !== -1) currentItems[idx] = sItem; else currentItems.push(sItem);
                });
                renderSchedule();
            } else { currentItems = initial; saveScheduleToFirestore(initial); renderSchedule(); }
        });
    }

    function createScheduleItemHTML(item) {
        const vibe = getCategoryVibe(item.category);
        const isEditable = item.id.startsWith('custom-') || ['item-hotel-ph','item-bf-ph','item-check-out'].includes(item.id);
        let mapBtn = '';
        if (item.location) {
            const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`;
            mapBtn = `<a href="${mapUrl}" target="_blank" class="inline-flex items-center gap-1 mt-2 text-xs font-bold text-blue-600 bg-blue-50 px-3 py-1.5 rounded-full hover:bg-blue-100 transition-colors">
                        <i class="fas fa-map-marker-alt"></i> ${item.location} <i class="fas fa-external-link-alt text-[9px] ml-1"></i>
                      </a>`;
        }
        return `
            <div id="${item.id}" class="flex gap-3">
                <div class="flex flex-col items-center pt-1 min-w-[3rem]">
                    <div class="text-sm font-black text-gray-500 font-mono">${item.time}</div>
                    <div class="w-0.5 bg-gray-200 h-full mt-1 rounded-full"></div>
                </div>
                <div class="flex-1 bg-white p-4 rounded-2xl shadow-sm border border-gray-100 relative group active:scale-[0.99] transition-transform">
                    ${isEditable ? `<button class="edit-btn absolute top-3 right-3 text-gray-300 hover:text-blue-500 p-2" data-item-id="${item.id}"><i class="fas fa-pencil-alt"></i></button>` : ''}
                    <span class="inline-block text-[10px] font-bold px-2 py-0.5 rounded mb-1 tracking-wide" style="background-color: ${vibe.bgHex}; color: ${vibe.hex}">${vibe.label}</span>
                    <h3 class="font-bold text-gray-800 text-lg leading-tight">${item.title}</h3>
                    <p class="text-sm text-gray-500 mt-1 leading-relaxed">${item.content}</p>
                    ${mapBtn}
                </div>
            </div>`;
    }

    function renderDateSlider() {
        const slider = document.getElementById('date-slider');
        slider.innerHTML = '';
        TRIP_DATES.forEach(d => {
            const active = d.day === currentDay;
            slider.insertAdjacentHTML('beforeend', `
                <div class="flex-shrink-0 text-center cursor-pointer px-1 ${active ? '' : 'opacity-40 hover:opacity-70'}" onclick="switchDay(${d.day})"> 
                    <div class="text-[10px] font-bold ${active ? 'text-green-600' : 'text-gray-400'}">${d.week}</div>
                    <div class="text-xl font-black ${active ? 'text-gray-800 border-b-2 border-green-500' : 'text-gray-400'} pb-1">${d.date}</div>
                </div>`);
        });
    }
    
    function renderHeroAndTitle(day) {
        const conf = TRIP_DATES.find(d => d.day === day) || TRIP_DATES[0];
        document.getElementById('current-day-title').textContent = conf.label;
        document.getElementById('hero-main-title').textContent = conf.heroTitle;
        document.getElementById('hero-tag').textContent = conf.tag;
        document.getElementById('hero-subtitle').textContent = day === 7 ? 'å›ç¨‹: BR197' : `${conf.date} Feb, 2026`;
    }

    function renderSchedule() {
        const container = document.getElementById('schedule-container');
        container.innerHTML = ''; 
        currentItems.sort((a, b) => a.time.localeCompare(b.time));
        currentItems.forEach(item => container.insertAdjacentHTML('beforeend', createScheduleItemHTML(item)));
    }

    function switchDay(day) {
        if (day === currentDay) return;
        currentDay = day;
        renderDateSlider(); renderHeroAndTitle(day); listenForScheduleUpdates(day); 
        document.getElementById('add-budget-day').textContent = `Day ${day}`;
        if(!document.getElementById('budget-page').classList.contains('hidden')) { renderBudgetSummary(); renderBudgetList(); }
    }

    function showModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    
    async function addScheduleItem() {
        const time = document.getElementById('new-time').value;
        const title = document.getElementById('new-title').value;
        const location = document.getElementById('new-location').value; 
        const content = document.getElementById('new-content').value || 'ç„¡è©³ç´°èªªæ˜';
        const cat = document.getElementById('new-category').value;
        if (!title || !time) return alert("è«‹è¼¸å…¥æ™‚é–“å’Œæ¨™é¡Œ");
        const newItem = { id: 'custom-'+Date.now(), time, title, content, category: cat, location };
        const itemsToSave = [...currentItems.filter(i => !i.isStatic), newItem];
        await saveScheduleToFirestore(itemsToSave);
        closeModal('add-modal');
        document.getElementById('new-title').value = ''; document.getElementById('new-location').value = ''; document.getElementById('new-content').value = '';
    }

    function prepareEdit(id) {
        const item = currentItems.find(i => i.id === id);
        if (!item) return;
        document.getElementById('edit-time').value = item.time;
        document.getElementById('edit-title').value = item.title;
        document.getElementById('edit-location').value = item.location || '';
        document.getElementById('edit-content').value = item.content;
        document.getElementById('edit-category').value = item.category;
        document.getElementById('editing-item-id').value = id;
        showModal('edit-modal');
    }

    async function saveEdit() {
        const id = document.getElementById('editing-item-id').value;
        const time = document.getElementById('edit-time').value;
        const title = document.getElementById('edit-title').value;
        const location = document.getElementById('edit-location').value;
        const content = document.getElementById('edit-content').value;
        const cat = document.getElementById('edit-category').value;
        if (!title || !time) return alert("æ¨™é¡Œæ™‚é–“å¿…å¡«");
        const updated = { id, time, title, content, category: cat, location };
        let itemsToSave = currentItems.filter(i => !i.isStatic || ['item-hotel-ph','item-bf-ph','item-check-out'].includes(i.id));
        const idx = itemsToSave.findIndex(i => i.id === id);
        if (idx !== -1) itemsToSave[idx] = updated; else itemsToSave.push(updated);
        await saveScheduleToFirestore(itemsToSave);
        closeModal('edit-modal');
    }
    
    async function deleteScheduleItem() {
        if(!confirm('åˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ')) return;
        const id = document.getElementById('editing-item-id').value;
        let itemsToSave = currentItems.filter(i => !i.isStatic || ['item-hotel-ph','item-bf-ph','item-check-out'].includes(i.id)).filter(i => i.id !== id);
        await saveScheduleToFirestore(itemsToSave);
        closeModal('edit-modal');
    }

    document.addEventListener('click', (e) => {
        const btn = e.target.closest('.edit-btn');
        if (btn) prepareEdit(btn.getAttribute('data-item-id'));
    });

    document.addEventListener('DOMContentLoaded', () => {
        renderDateSlider(); renderHeroAndTitle(currentDay); switchPage('schedule');
        loadExchangeRate(); listenForScheduleUpdates(currentDay); listenForBudgetUpdates(); listenForChecklistUpdates();
        fetchWeather();
    });

    window.switchDay = switchDay; window.switchPage = switchPage; window.prepareRateModal = prepareRateModal;
    window.saveExchangeRate = saveExchangeRate; window.addBudgetItem = addBudgetItem; window.deleteBudgetItem = deleteBudgetItem;
    window.showModal = showModal; window.closeModal = closeModal; window.saveEdit = saveEdit; window.deleteScheduleItem = deleteScheduleItem;
    window.addScheduleItem = addScheduleItem; window.addChecklistItem = addChecklistItem; window.toggleChecklist = toggleChecklist; window.deleteChecklist = deleteChecklist;
</script>
</body>
</html>
