<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title id="app-title">æ±äº¬ä¹‹æ—… 2026 (æ‹–æ›³ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        html, body {
            height: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow-x: hidden !important;
            box-sizing: border-box !important;
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f3f4f6;
            -webkit-font-smoothing: antialiased; 
            -webkit-tap-highlight-color: transparent; 
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .modal {
            opacity: 0;
            visibility: hidden;
            display: none; 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 9999 !important; 
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }
        .modal.active {
            opacity: 1;
            visibility: visible;
            display: flex; 
        }

        .fixed-header {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 1000 !important; 
        }
        
        .fixed-footer {
            position: fixed !important;
            bottom: 24px !important; 
            left: 24px !important;
            right: 24px !important;
            z-index: 1001 !important; 
        }

        .page-content {
            padding-top: 155px; /* ç¨å¾®å¢åŠ é«˜åº¦çµ¦ç¸½é‡‘é¡é¡¯ç¤º */
            padding-bottom: 7rem; 
            min-height: 100vh;
        }
        
        /* æ‹–æ›³æ™‚çš„æ¨£å¼ */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #f3f4f6;
            border: 2px dashed #cbd5e1;
        }
        .sortable-drag {
            background-color: white;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform: scale(1.02);
        }
        
        .check-item.completed .check-text {
            text-decoration: line-through;
            color: #9ca3af;
        }
        .check-item.completed .check-circle {
            background-color: #10b981;
            border-color: #10b981;
            color: white;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="schedule-page" class="page-content">
        <div class="fixed-header bg-white/95 backdrop-blur-md border-b border-gray-200 pt-10 pb-2 px-4 shadow-sm">
            <div class="flex justify-between items-center mb-2">
                <div>
                    <p class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Tokyo Trip 2026</p>
                    <h1 class="text-xl font-black text-gray-900 leading-tight" id="current-day-title">Day 1 å‡ºç™¼</h1>
                </div>
                
                <div class="text-right">
                    <div class="text-[10px] text-gray-400 font-bold uppercase">ä»Šæ—¥ç¸½èŠ±è²»</div>
                    <div class="text-lg font-black text-red-600 leading-none" id="header-daily-cost">Â¥ 0</div>
                    <div class="text-[10px] text-gray-400" id="header-twd-cost">â‰ˆ NT$ 0</div>
                </div>
            </div>
            
            <div class="flex overflow-x-auto gap-4 mt-2 pb-2 hide-scrollbar z-10" id="date-slider"></div>
        </div>

        <div class="px-4 space-y-5"> 
            <div class="text-right">
                <button onclick="prepareRateModal()" class="text-[10px] text-gray-400 bg-gray-100 px-2 py-1 rounded-full">
                    <i class="fas fa-cog mr-1"></i>åŒ¯ç‡: <span id="display-rate">0.22</span>
                </button>
            </div>

            <div id="loading-status" class="text-center text-xs text-gray-400 mt-2">
                 <i class="fas fa-spinner fa-spin mr-1"></i> è³‡æ–™åŒæ­¥ä¸­...
            </div>
            
            <div id="schedule-container" class="space-y-4 pb-10"></div>
        </div>
    </div>

    <div id="checklist-page" class="hidden page-content px-4" style="padding-top: 2rem;">
        <h1 class="text-2xl font-black mb-4 flex items-center gap-2">
            <span class="bg-purple-100 text-purple-600 p-2 rounded-lg text-xl"><i class="fas fa-clipboard-check"></i></span>
            å¿…è²· & æº–å‚™æ¸…å–®
        </h1>

        <div class="flex gap-2 mb-4">
            <input type="text" id="checklist-input" placeholder="æ–°å¢é …ç›®..." 
                class="flex-1 p-3 border border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
            <button onclick="addChecklistItem()" class="bg-purple-600 text-white px-4 rounded-xl font-bold shadow-md active:scale-95 transition">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <div id="checklist-container" class="space-y-2 pb-20">
            <div class="text-center text-gray-400 text-sm mt-10">
                <i class="fas fa-box-open text-2xl mb-2"></i><br>æ¸…å–®ç›®å‰æ˜¯ç©ºçš„
            </div>
        </div>
    </div>

    <div id="add-modal" class="modal inset-0 bg-black/60 backdrop-blur-sm items-center justify-center p-4" onclick="closeModal('add-modal')">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl transform transition-all scale-100" onclick="event.stopPropagation()">
            <h2 class="text-xl font-bold mb-4 text-gray-800">æ–°å¢è¡Œç¨‹ & èŠ±è²»</h2>
            <div class="space-y-3">
                <div class="flex gap-2">
                    <input type="time" id="new-time" class="w-1/3 p-3 bg-gray-50 border border-gray-200 rounded-xl text-lg font-bold text-center" value="09:00">
                    <select id="new-category" class="w-2/3 p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm font-medium">
                        <option value="FOOD">ğŸ´ é¤é£²</option>
                        <option value="SHOPPING">ğŸ› è³¼ç‰©</option>
                        <option value="SIGHTSEEING">â›© æ™¯é»</option>
                        <option value="TRANSPORT">ğŸš„ äº¤é€š</option>
                        <option value="HOTEL">ğŸ¨ ä½å®¿</option>
                        <option value="OTHER">ğŸ’¡ å…¶ä»–</option>
                    </select>
                </div>
                <input type="text" id="new-title" placeholder="è¡Œç¨‹æ¨™é¡Œ (ä¾‹å¦‚: ä¸€è˜­æ‹‰éºµ)" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold">
                
                <div class="relative">
                    <span class="absolute left-4 top-3.5 text-gray-400 font-bold">Â¥</span>
                    <input type="number" id="new-cost" placeholder="é‡‘é¡ (é¸å¡«)" class="w-full p-3 pl-8 bg-red-50 border border-red-100 rounded-xl font-bold text-red-600 focus:border-red-500 focus:bg-white transition-colors">
                </div>

                <input type="text" id="new-location" placeholder="ğŸ“ åœ°é» (Google Maps)" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm">
                <textarea id="new-content" placeholder="å‚™è¨»å…§å®¹..." class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl h-20 text-sm"></textarea>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeModal('add-modal')" class="px-5 py-2.5 text-gray-500 font-medium rounded-xl hover:bg-gray-100">å–æ¶ˆ</button>
                <button onclick="addScheduleItem()" class="px-5 py-2.5 bg-green-600 text-white rounded-xl shadow-lg shadow-green-200 font-bold hover:bg-green-700">æ–°å¢</button>
            </div>
        </div>
    </div>
    
    <div id="edit-modal" class="modal inset-0 bg-black/60 backdrop-blur-sm items-center justify-center p-4" onclick="closeModal('edit-modal')">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl" onclick="event.stopPropagation()">
            <h2 class="text-xl font-bold mb-4 text-gray-800">ç·¨è¼¯é …ç›®</h2>
            <div class="space-y-3">
                <div class="flex gap-2">
                    <input type="time" id="edit-time" class="w-1/3 p-3 bg-gray-50 border border-gray-200 rounded-xl text-lg font-bold text-center">
                    <select id="edit-category" class="w-2/3 p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm font-medium">
                        <option value="FOOD">ğŸ´ é¤é£²</option>
                        <option value="SHOPPING">ğŸ› è³¼ç‰©</option>
                        <option value="SIGHTSEEING">â›© æ™¯é»</option>
                        <option value="TRANSPORT">ğŸš„ äº¤é€š</option>
                        <option value="HOTEL">ğŸ¨ ä½å®¿</option>
                        <option value="OTHER">ğŸ’¡ å…¶ä»–</option>
                    </select>
                </div>
                <input type="text" id="edit-title" placeholder="æ¨™é¡Œ" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold">
                
                <div class="relative">
                    <span class="absolute left-4 top-3.5 text-gray-400 font-bold">Â¥</span>
                    <input type="number" id="edit-cost" placeholder="é‡‘é¡ (é¸å¡«)" class="w-full p-3 pl-8 bg-red-50 border border-red-100 rounded-xl font-bold text-red-600 focus:border-red-500 focus:bg-white transition-colors">
                </div>

                <input type="text" id="edit-location" placeholder="ğŸ“ åœ°é»" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm">
                <textarea id="edit-content" placeholder="è©³ç´°å…§å®¹..." class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl h-20 text-sm"></textarea>
            </div>
            <div class="flex justify-between items-center mt-6">
                 <button onclick="deleteScheduleItem()" class="px-4 py-2 text-red-500 rounded-xl hover:bg-red-50 text-sm font-medium"><i class="fas fa-trash-alt mr-1"></i> åˆªé™¤</button>
                <div class="space-x-2">
                    <button onclick="closeModal('edit-modal')" class="px-4 py-2 text-gray-500 font-medium rounded-xl hover:bg-gray-100">å–æ¶ˆ</button>
                    <button onclick="saveEdit()" class="px-5 py-2 bg-blue-600 text-white rounded-xl shadow-lg shadow-blue-200 font-bold hover:bg-blue-700">å„²å­˜</button>
                </div>
            </div>
             <input type="hidden" id="editing-item-id">
        </div>
    </div>
    
    <div id="rate-modal" class="modal inset-0 bg-black/60 backdrop-blur-sm items-center justify-center p-4" onclick="closeModal('rate-modal')">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl" onclick="event.stopPropagation()">
            <h2 class="text-xl font-bold mb-2">åŒ¯ç‡è¨­å®š</h2>
            <p class="text-sm text-gray-500 mb-4">1 JPY â‰ˆ ? TWD</p>
            <div class="flex items-center space-x-2 bg-gray-50 p-4 rounded-xl border border-gray-200">
                <span class="text-lg font-bold text-gray-400">Ã—</span>
                <input type="number" step="0.0001" id="exchange-rate-input" class="flex-1 bg-transparent text-2xl font-bold text-center focus:outline-none" placeholder="0.22">
            </div>
            <div class="flex justify-end mt-6">
                <button onclick="saveExchangeRate()" class="px-5 py-2 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-lg">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div class="fixed-footer bg-white text-gray-400 rounded-2xl shadow-[0_8px_30px_rgb(0,0,0,0.12)] h-16 flex items-center justify-around px-2 border border-gray-100">
        <button id="tab-schedule" onclick="switchPage('schedule')" class="p-2 w-14 flex flex-col items-center justify-center text-green-600 transition-colors">
            <i class="fas fa-map-marked-alt text-xl mb-1"></i>
            <span class="text-[9px] font-bold">è¡Œç¨‹</span>
        </button>
        <div id="add-schedule-btn" onclick="showModal('add-modal')" class="bg-gray-900 text-white w-14 h-14 rounded-2xl flex items-center justify-center -mt-8 shadow-lg shadow-gray-400/50 cursor-pointer active:scale-95 transition-transform border-4 border-gray-100">
            <i class="fas fa-plus text-xl"></i>
        </div>
        <button id="tab-checklist" onclick="switchPage('checklist')" class="p-2 w-14 flex flex-col items-center justify-center hover:text-purple-500 transition-colors">
            <i class="fas fa-clipboard-list text-xl mb-1"></i>
            <span class="text-[9px] font-bold">æ¸…å–®</span>
        </button>
    </div>


<script>
    // =======================================================
    // å…¨åŸŸè®Šæ•¸ & é…ç½®
    // =======================================================
    let currentDay = 1; 
    let currentItems = []; 
    let firestoreScheduleListener = null;
    let firestoreChecklistListener = null;
    let exchangeRate = 0.22; 
    let checklistItems = [];
    let sortableInstance = null; // æ‹–æ›³å¯¦é«”

    const TRIP_DATES = [
        { day: 1, label: 'Day 1 å‡ºç™¼', week: 'WED', date: '04', title: 'æ±äº¬ Start!' },
        { day: 2, label: 'Day 2 æ¢ç´¢', week: 'THU', date: '05', title: 'ç¯‰åœ°ã€æ·ºè‰' },
        { day: 3, label: 'Day 3 è³¼ç‰©', week: 'FRI', date: '06', title: 'æ–°å®¿ã€æ¾€è°·' },
        { day: 4, label: 'Day 4 å‹•æ¼«', week: 'SAT', date: '07', title: 'ç§‹è‘‰åŸ' },
        { day: 5, label: 'Day 5 æ¨‚åœ’', week: 'SUN', date: '08', title: 'è¿ªå£«å°¼' },
        { day: 6, label: 'Day 6 æ©«æ¿±', week: 'MON', date: '09', title: 'æ©«æ¿±ä¸€æ—¥' },
        { day: 7, label: 'Day 7 å›ç¨‹', week: 'TUE', date: '10', title: 'Bye Tokyo' },
    ];

    // Firebase Config (ä½ çš„é‘°åŒ™)
    const firebaseConfig = {
      apiKey: "AIzaSyBSIP0E7wHTxEnoGmBnqe3IrdojWSTZu0A",
      authDomain: "tokyotrip2026-24a2c.firebaseapp.com",
      projectId: "tokyotrip2026-24a2c",
      storageBucket: "tokyotrip2026-24a2c.firebasestorage.app",
      messagingSenderId: "473041619302",
      appId: "1:473041619302:web:477c0eee8903999012a0a7"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // â˜…â˜…â˜… æ”¹ç”¨ V3 ç¢ºä¿å…¨æ–°è³‡æ–™çµæ§‹ â˜…â˜…â˜…
    const SCHEDULE_COLLECTION = 'trip_schedules_v3';
    const CHECKLIST_COLLECTION = 'trip_checklist'; 
    const CONFIG_DOCUMENT_ID = 'trip_config';

    function getDocumentId(day) {
        return `tokyo_feb_2026_day_${day}`;
    }

    // =======================================================
    // æ ¸å¿ƒåŠŸèƒ½ï¼šè¼‰å…¥ã€æ‹–æ›³ã€è¨ˆç®—
    // =======================================================

    function listenForScheduleUpdates(day) {
        if (firestoreScheduleListener) firestoreScheduleListener();
        const loading = document.getElementById('loading-status');
        
        firestoreScheduleListener = db.collection(SCHEDULE_COLLECTION).doc(getDocumentId(day)).onSnapshot(doc => {
            loading.style.opacity = '0';
            if (doc.exists) {
                // è®€å–å·²å„²å­˜çš„é †åº
                currentItems = doc.data().schedule || [];
            } else {
                currentItems = []; // é è¨­å…¨ç©º
            }
            renderSchedule();
            calculateTotalCost(); // æ¯æ¬¡æ›´æ–°éƒ½é‡ç®—é‡‘é¡
        });
    }

    async function saveScheduleToFirestore(items) {
        // ç›´æ¥å„²å­˜æ•´å€‹é™£åˆ—ï¼Œé †åºå°±æ˜¯é™£åˆ—çš„é †åº
        try { 
            await db.collection(SCHEDULE_COLLECTION).doc(getDocumentId(currentDay)).set({ 
                schedule: items, 
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp() 
            }); 
        } catch (e) { console.error(e); }
    }

    // åˆå§‹åŒ–æ‹–æ›³åŠŸèƒ½
    function initSortable() {
        const el = document.getElementById('schedule-container');
        if (sortableInstance) sortableInstance.destroy(); // æ¸…é™¤èˆŠçš„
        
        sortableInstance = new Sortable(el, {
            handle: '.drag-handle', // åªå…è¨±æ‹‰ã€Œä¸‰æ¢ç·šã€åœ–ç¤º
            animation: 150,
            delay: 100, // é˜²æ­¢èª¤è§¸
            delayOnTouchOnly: true,
            ghostClass: 'sortable-ghost',
            dragClass: 'sortable-drag',
            onEnd: function (evt) {
                // æ‹–æ›³çµæŸå¾Œï¼Œé‡æ–°æ’åˆ— currentItems é™£åˆ—
                const itemEl = currentItems[evt.oldIndex];
                currentItems.splice(evt.oldIndex, 1); // ç§»é™¤èˆŠä½ç½®
                currentItems.splice(evt.newIndex, 0, itemEl); // æ’å…¥æ–°ä½ç½®
                
                // å„²å­˜åˆ° Firebase
                saveScheduleToFirestore(currentItems);
            },
        });
    }

    function renderSchedule() {
        const container = document.getElementById('schedule-container');
        container.innerHTML = ''; 
        
        if (currentItems.length === 0) {
            container.innerHTML = `<div class="text-center text-gray-300 py-10">é»æ“Šä¸‹æ–¹ + æ–°å¢è¡Œç¨‹</div>`;
            return;
        }

        // ä¸å†ç”¨æ™‚é–“æ’åºï¼Œè€Œæ˜¯ä¾ç…§é™£åˆ—é †åºæ¸²æŸ“ (æ”¯æ´æ‹–æ›³çµæœ)
        currentItems.forEach(item => {
            container.insertAdjacentHTML('beforeend', createScheduleItemHTML(item));
        });
        
        // é‡æ–°ç¶å®šæ‹–æ›³
        initSortable();
    }

    function createScheduleItemHTML(item) {
        const vibe = getCategoryVibe(item.category);
        const cost = item.cost ? parseInt(item.cost) : 0;
        const costHTML = cost > 0 
            ? `<div class="mt-2 inline-flex items-center bg-red-50 px-2 py-1 rounded-lg border border-red-100">
                 <span class="text-[10px] text-red-400 font-bold mr-1">Â¥</span>
                 <span class="text-sm font-black text-red-600">${cost.toLocaleString()}</span>
               </div>` 
            : '';

        return `
            <div class="flex gap-3 items-start group relative" data-id="${item.id}">
                <div class="flex flex-col items-center pt-2 min-w-[3.5rem]">
                    <div class="text-sm font-black text-gray-500 font-mono bg-gray-100 px-1 rounded">${item.time}</div>
                    <div class="w-0.5 bg-gray-200 h-full mt-1 rounded-full min-h-[3rem]"></div>
                </div>
                
                <div class="flex-1 bg-white p-4 rounded-2xl shadow-sm border-l-4 border-${vibe.color}-500 relative overflow-hidden" style="border-left-color: ${vibe.hex}">
                    
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="inline-block text-[10px] font-bold text-gray-500 bg-gray-100 px-2 py-0.5 rounded mb-1">${vibe.label}</span>
                            <h3 class="font-bold text-gray-800 text-lg leading-tight">${item.title}</h3>
                        </div>
                        <button class="edit-btn text-gray-300 p-2 hover:text-blue-500 -mr-2 -mt-2" data-item-id="${item.id}">
                            <i class="fas fa-pen text-xs"></i>
                        </button>
                    </div>

                    <p class="text-sm text-gray-500 mt-1 leading-relaxed">${item.content || ''}</p>
                    
                    ${item.location ? `<div class="text-xs text-blue-500 mt-1 font-bold"><i class="fas fa-map-marker-alt mr-1"></i>${item.location}</div>` : ''}
                    
                    ${costHTML}
                </div>

                <div class="drag-handle flex items-center justify-center w-8 h-full self-center cursor-move touch-none text-gray-300 hover:text-gray-500">
                    <i class="fas fa-bars text-lg"></i>
                </div>
            </div>`;
    }

    function calculateTotalCost() {
        const total = currentItems.reduce((sum, item) => sum + (parseInt(item.cost) || 0), 0);
        document.getElementById('header-daily-cost').textContent = `Â¥ ${total.toLocaleString()}`;
        document.getElementById('header-twd-cost').textContent = `â‰ˆ NT$ ${Math.round(total * exchangeRate).toLocaleString()}`;
    }

    function getCategoryVibe(category) {
        const map = {
            'FOOD': { hex: '#f97316', color: 'orange', label: 'é¤é£²' },
            'SIGHTSEEING': { hex: '#ef4444', color: 'red', label: 'æ™¯é»' },
            'TRANSPORT': { hex: '#3b82f6', color: 'blue', label: 'äº¤é€š' },
            'SHOPPING': { hex: '#ec4899', color: 'pink', label: 'è³¼ç‰©' },
            'HOTEL': { hex: '#a855f7', color: 'purple', label: 'ä½å®¿' },
            'OTHER': { hex: '#6b7280', color: 'gray', label: 'å…¶ä»–' }
        };
        return map[category] || map['OTHER'];
    }

    // =======================================================
    // åŸºæœ¬ UI æ“ä½œ
    // =======================================================
    
    function renderDateSlider() {
        const slider = document.getElementById('date-slider');
        slider.innerHTML = '';
        TRIP_DATES.forEach(d => {
            const active = d.day === currentDay;
            slider.insertAdjacentHTML('beforeend', `
                <div class="flex-shrink-0 text-center cursor-pointer px-1 ${active ? '' : 'opacity-40 hover:opacity-70'}" onclick="switchDay(${d.day})"> 
                    <div class="text-[10px] font-bold ${active ? 'text-green-600' : 'text-gray-400'}">${d.week}</div>
                    <div class="text-xl font-black ${active ? 'text-gray-800 border-b-2 border-green-500' : 'text-gray-400'} pb-1">${d.date}</div>
                </div>`);
        });
    }
    
    function renderHeroAndTitle(day) {
        const conf = TRIP_DATES.find(d => d.day === day) || TRIP_DATES[0];
        document.getElementById('current-day-title').textContent = conf.label;
    }

    function switchDay(day) {
        if (day === currentDay) return;
        currentDay = day;
        renderDateSlider(); renderHeroAndTitle(day); listenForScheduleUpdates(day); 
    }

    function switchPage(page) {
        document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
        document.getElementById(`${page}-page`).classList.remove('hidden');
        
        const tabSchedule = document.getElementById('tab-schedule');
        const tabChecklist = document.getElementById('tab-checklist');
        
        tabSchedule.className = "p-2 w-14 flex flex-col items-center justify-center transition-colors " + (page === 'schedule' ? "text-green-600" : "text-gray-400");
        tabChecklist.className = "p-2 w-14 flex flex-col items-center justify-center transition-colors " + (page === 'checklist' ? "text-purple-600" : "text-gray-400");
    }

    function showModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    
    // æ–°å¢åŠŸèƒ½ (æ•´åˆ)
    async function addScheduleItem() {
        const time = document.getElementById('new-time').value;
        const title = document.getElementById('new-title').value;
        const cost = document.getElementById('new-cost').value;
        const location = document.getElementById('new-location').value; 
        const content = document.getElementById('new-content').value;
        const cat = document.getElementById('new-category').value;
        
        if (!title) return alert("è«‹è¼¸å…¥æ¨™é¡Œ");
        
        const newItem = { 
            id: 'item-' + Date.now(), 
            time, title, content, category: cat, location, 
            cost: cost ? parseInt(cost) : 0 
        };
        
        const itemsToSave = [...currentItems, newItem];
        // æŒ‰ç…§æ™‚é–“ç°¡å–®æ’åºä¸€æ¬¡ï¼Œä¹‹å¾Œè®“ä½¿ç”¨è€…è‡ªå·±æ‹–æ›³
        itemsToSave.sort((a, b) => a.time.localeCompare(b.time));
        
        await saveScheduleToFirestore(itemsToSave);
        closeModal('add-modal');
        
        // æ¸…ç©º
        document.getElementById('new-title').value = ''; 
        document.getElementById('new-cost').value = '';
        document.getElementById('new-location').value = ''; 
        document.getElementById('new-content').value = '';
    }

    // ç·¨è¼¯åŠŸèƒ½ (æ•´åˆ)
    function prepareEdit(id) {
        const item = currentItems.find(i => i.id === id);
        if (!item) return;
        document.getElementById('edit-time').value = item.time;
        document.getElementById('edit-title').value = item.title;
        document.getElementById('edit-cost').value = item.cost || '';
        document.getElementById('edit-location').value = item.location || '';
        document.getElementById('edit-content').value = item.content || '';
        document.getElementById('edit-category').value = item.category;
        document.getElementById('editing-item-id').value = id;
        showModal('edit-modal');
    }

    async function saveEdit() {
        const id = document.getElementById('editing-item-id').value;
        const time = document.getElementById('edit-time').value;
        const title = document.getElementById('edit-title').value;
        const cost = document.getElementById('edit-cost').value;
        const location = document.getElementById('edit-location').value;
        const content = document.getElementById('edit-content').value;
        const cat = document.getElementById('edit-category').value;
        
        if (!title) return alert("æ¨™é¡Œå¿…å¡«");
        
        const updated = { 
            id, time, title, content, category: cat, location,
            cost: cost ? parseInt(cost) : 0
        };
        
        const idx = currentItems.findIndex(i => i.id === id);
        if (idx !== -1) currentItems[idx] = updated;
        
        await saveScheduleToFirestore(currentItems);
        closeModal('edit-modal');
    }
    
    async function deleteScheduleItem() {
        if(!confirm('åˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ')) return;
        const id = document.getElementById('editing-item-id').value;
        const newItems = currentItems.filter(i => i.id !== id);
        await saveScheduleToFirestore(newItems);
        closeModal('edit-modal');
    }

    // Checklist & Rate (ä¿ç•™åŸåŠŸèƒ½)
    function listenForChecklistUpdates() {
        if (firestoreChecklistListener) firestoreChecklistListener();
        firestoreChecklistListener = db.collection(CHECKLIST_COLLECTION).orderBy('timestamp', 'desc')
            .onSnapshot(snapshot => {
                checklistItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderChecklist();
            });
    }
    async function addChecklistItem() {
        const input = document.getElementById('checklist-input');
        const text = input.value.trim();
        if(!text) return;
        try { await db.collection(CHECKLIST_COLLECTION).add({ text, isCompleted: false, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); input.value = ''; } catch (e) {}
    }
    async function toggleChecklist(id, status) { try { await db.collection(CHECKLIST_COLLECTION).doc(id).update({ isCompleted: !status }); } catch (e) {} }
    async function deleteChecklist(id) { if(confirm("åˆªé™¤?")) try { await db.collection(CHECKLIST_COLLECTION).doc(id).delete(); } catch (e) {} }
    
    async function loadExchangeRate() {
        try { const doc = await db.collection(CONFIG_DOCUMENT_ID).doc('rate').get(); if (doc.exists) { exchangeRate = doc.data().val; document.getElementById('display-rate').textContent = exchangeRate; } } catch (e) {}
    }
    async function saveExchangeRate() {
        const r = parseFloat(document.getElementById('exchange-rate-input').value);
        if(r) { exchangeRate = r; document.getElementById('display-rate').textContent = r; await db.collection(CONFIG_DOCUMENT_ID).doc('rate').set({val: r}); closeModal('rate-modal'); calculateTotalCost(); }
    }
    function prepareRateModal() { document.getElementById('exchange-rate-input').value = exchangeRate; showModal('rate-modal'); }

    document.addEventListener('click', (e) => {
        const btn = e.target.closest('.edit-btn');
        if (btn) prepareEdit(btn.getAttribute('data-item-id'));
    });

    document.addEventListener('DOMContentLoaded', () => {
        renderDateSlider(); renderHeroAndTitle(currentDay); switchPage('schedule');
        listenForScheduleUpdates(currentDay); listenForChecklistUpdates(); loadExchangeRate();
    });

    window.switchDay = switchDay; window.switchPage = switchPage; window.prepareRateModal = prepareRateModal;
    window.saveExchangeRate = saveExchangeRate; window.addChecklistItem = addChecklistItem;
    window.showModal = showModal; window.closeModal = closeModal; window.saveEdit = saveEdit; window.deleteScheduleItem = deleteScheduleItem;
    window.addScheduleItem = addScheduleItem; window.toggleChecklist = toggleChecklist; window.deleteChecklist = deleteChecklist;
</script>
</body>
</html>
